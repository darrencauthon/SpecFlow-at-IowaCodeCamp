Feature: Manage Shopping Cart
	In order to select the products I wish to purchase
	As a customer
	I want to be view and edit what is in my cart

Background:
	Given I am not logged in
	And the system is using the real checkout context

Scenario: View products in my cart
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 2        | tn.jpg    | URL |
	When I visit the shopping cart page
	Then I should get the Index view
	And I should see the following shopping cart view:
	| SubTotal | ReceiveFutureBookstoreEmails |
	| 50.86    | true                         |
	And I should see the following cart product list views:
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Total | Url |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 2        | tn.jpg    | 50.86 | URL |

Scenario: No products are in the cart and a checkout controller exists
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail |
	And the page repository has the following pages
	| Id | Controller | Url       |
	| x  | Checkout   | /Checkout |
	When I visit the shopping cart page
	Then I should get a redirect result going to url /Checkout/EmptyCart

Scenario: No products are in the cart and a checkout controller does not exist
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url |
	And the page repository has the following pages
	| Id | Controller | Url       |
	| x  | Content    | /Checkout |
	When I visit the shopping cart page
	Then I should get a redirect result going to url /

Scenario: Updating products in the cart
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 3        | tn.jpg    | URL1 |
	| FH | Fountainhead   | Ayn Rand | FNTNHD      | 20.13 | 1        | fh.jpg    | URL2 |
	And I enter the following data on the product list views
	| Id | Quantity | RemoveFromCart |
	| AS | 3        | false          |
	| FH | 7        | true           |
	And I enter the following data on the shopping cart input model
	| Field                       | Value |
	|ReceiveFutureBookstoreEmails | true |
	When I click continue on the shopping cart page
	Then I should have the following products in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 3        | tn.jpg    | URL1 |
	And I should have the following bool values in my billing and shipping data
	| Field                              | Value |
	| ReceiveFutureBookstoreEmails       | true  |
	And a message should be passed on the bus notifying that the cart was updated

Scenario: Updating products in the cart Only
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 3        | tn.jpg    | URL1 |
	| FH | Fountainhead   | Ayn Rand | FNTNHD      | 20.13 | 1        | fh.jpg    | URL2 |
	And I enter the following data on the product list views
	| Id | Quantity | RemoveFromCart |
	| AS | 3        | false          |
	| FH | 7        | true           |
	And I enter the following data on the shopping cart input model
	| Field                        | Value |
	| ReceiveFutureBookstoreEmails | false |
	| UpdateOnly                   | 1     |
	When I click continue on the shopping cart page
	Then I should have the following products in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 3        | tn.jpg    | URL1 |
	And I should get a redirect to Index action on the Checkout controller

Scenario: Removing products from the cart
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 2        | tn.jpg    | URL1 |
	| FH | Fountainhead   | Ayn Rand | FNTNHD      | 20.13 | 1        | fh.jpg    | URL2 |
	And I enter the following data on the product list views
	| Id | Quantity |
	| AS | 3        |
	| FH | 7        |
	When I click continue on the shopping cart page
	Then I should have the following products in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 3        | tn.jpg    | URL1 |
	| FH | Fountainhead   | Ayn Rand | FNTNHD      | 20.13 | 7        | fh.jpg    | URL2 |


Scenario: Move to the login step when not logged in
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 2        | tn.jpg    | URL1 |
	| FH | Fountainhead   | Ayn Rand | FNTNHD      | 20.13 | 1        | fh.jpg    | URL2 |
	And I enter the following data on the product list views
	| Id | Quantity |
	| AS | 3        |
	| FH | 7        |
	And I am not logged in
	When I click continue on the shopping cart page
	Then I should get a redirect to Login action on the Checkout controller

Scenario: Move to the billing and shipping step when logged in
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 2        | tn.jpg    | URL1 |
	| FH | Fountainhead   | Ayn Rand | FNTNHD      | 20.13 | 1        | fh.jpg    | URL2 |
	And I enter the following data on the product list views
	| Id | Quantity |
	| AS | 3        |
	| FH | 7        |
	And I am logged in
	When I click continue on the shopping cart page
	Then I should get a redirect to BillingAndShipping action on the Checkout controller

Scenario: Invalid inventory request
	Given the following products are in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 2        | tn.jpg    | URL1 |
	And I enter the following data on the product list views
	| Id | Quantity |
	| AS | 3        |
	And there are only 2 products with id of AS
	When I click continue on the shopping cart page
	Then I should have the following products in my cart
	| Id | Title          | Author   | ProductCode | Price | Quantity | Thumbnail | Url  |
	| AS | Atlas Shrugged | Ayn Rand | AtlShrg     | 25.43 | 3        | tn.jpg    | URL1 |
	Then I should get the Index view